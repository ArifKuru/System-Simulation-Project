{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>{{ project.project_name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body class="bg-gray-100 p-6">

<button onclick="runSimulation()" class="btn btn-warning">â–¶ Simulate</button>

<button onclick="resetStocks()" class="btn btn-outline-danger ms-2">â­¯ Reset Stocks</button>


<pre id="simResult" class="mt-3 bg-light p-2 rounded small text-break"></pre>

<div class="input-group my-3" style="max-width: 300px;">
  <input type="number" id="simStepCount" value="1000" min="1" class="form-control" placeholder="Steps">
  <button class="btn btn-warning" onclick="runSimulationSteps()">Simulate Steps</button>
</div>
<div style="width: 100%; max-width: 1000px; height: 400px; margin: auto;">
  <canvas id="stockChart"></canvas>
</div>
<div class="table-responsive">
  <table id="simTable" class="table table-bordered table-sm text-center align-middle">
    <thead class="table-light">
      <tr>
        <th>Step</th>
        <th>Time</th>
        <th>Event</th>
        <th>Stock</th>
        <th>Old Value</th>
        <th>New Value</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-md p-6 space-y-4">
        <h1 class="text-3xl font-bold">{{ project.project_name }}</h1>
        <img src="{{ project.image.url }}" alt="Project Image" class="w-full h-64 object-cover rounded-lg">
        <p class="text-gray-700">{{ project.description|default:"No description." }}</p>

        <p class="text-sm text-gray-500">Created at: {{ project.created_at|date:"d M Y H:i" }}</p>

        <!-- Add Stock Button -->
        <button onclick="document.getElementById('stockModal').classList.remove('hidden')"
                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
            + Add Stock
        </button>

        <!-- Stock List -->
<div id="stockList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    <!-- JS ile kartlar buraya eklenecek -->
</div>

    </div>

    <!-- Modal -->
    <div id="stockModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md relative">
            <button onclick="document.getElementById('stockModal').classList.add('hidden')"
                    class="absolute top-2 right-2 text-gray-500 hover:text-black text-xl">&times;</button>

            <h3 class="text-xl font-semibold mb-4">Add New Stock</h3>

<form id="addStockForm" class="space-y-4">
    <div>
        <label class="block text-sm font-medium">Stock Name</label>
        <input type="text" name="name" required class="w-full border rounded px-3 py-2 mt-1">
    </div>
    <div>
        <label class="block text-sm font-medium">Value</label>
        <input type="number" name="value" step="0.01" required class="w-full border rounded px-3 py-2 mt-1">
    </div>
    <div class="text-right">
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
            Save Stock
        </button>
    </div>
</form>
<!-- Stock + Events Modal -->

<!-- Toast -->
<div id="toast" class="fixed bottom-5 right-5 bg-green-600 text-white px-4 py-2 rounded shadow-lg hidden z-50"></div>
        </div>
    </div>

</body>
<div class="modal fade" id="stockDetailModal" tabindex="-1" aria-labelledby="stockDetailLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="stockDetailLabel">Stock Detail</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <p id="stockValue">Loading...</p>

        <h6>Events</h6>
        <ul id="eventList" class="list-group mb-3"></ul>

          <div id="stockVariables" class="mb-3">
    <p class="mb-1 fw-bold">Insert Variables:</p>
    <div id="stockVarsContainer" class="d-flex flex-wrap gap-2">
        <!-- JS ile doldurulacak -->
    </div>
</div>


        <form id="addEventForm" class="row g-2">
          <input type="hidden" name="stock_id" id="eventStockId">
          <div class="col-md-4">
            <input type="text" name="name" placeholder="Event Name" required class="form-control">
          </div>
          <div class="col-md-3">
            <input type="text" step="0.01" name="possibility" placeholder="Ex: 0.5 or stock('X') * 0.3" required class="form-control"
            ondrop="onDropVariable(event, this)" ondragover="allowDrop(event)">
          </div>
          <div class="col-md-3">
            <input type="text" name="effect" placeholder="Effect (*2, +5)" required class="form-control"
             ondrop="onDropVariable(event, this)" ondragover="allowDrop(event)">
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Add</button>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>
<script>
let bootstrapModal;

async function drawStockChart(simResults) {
    const labels = simResults.map(r => r.step);
    const stockNames = Object.keys(simResults[0].stock_values);

    const datasets = stockNames.map(name => {
        return {
            label: name,
            data: simResults.map(r => r.stock_values[name]),
            borderWidth: 2,
            borderColor: getRandomColor(),
            fill: false
        };
    });

    const ctx = document.getElementById("stockChart").getContext("2d");
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Stock Value Changes Over Steps'
                }
            },
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });
}

// basit random renk Ã¼retici
function getRandomColor() {
    return 'hsl(' + Math.floor(Math.random() * 360) + ', 70%, 60%)';
}


async function resetStocks() {
    if (!confirm("Are you sure you want to reset all stock values to their initial state?")) return;

    const res = await fetch(`/api/stocks/reset/{{ project.id }}/`, {
        method: "POST"
    });

    const data = await res.json();

    if (data.success) {
        showToast(data.message);
        fetchStocks();  // gÃ¼ncel deÄŸerleri gÃ¶ster
    } else {
        showToast(data.error || "Reset failed", true);
    }
}

function openStockModal(stockId) {
    bootstrapModal = new bootstrap.Modal(document.getElementById('stockDetailModal'));
    bootstrapModal.show();
    loadStockDetail(stockId);
        loadStockVariables({{ project.id }});

}

async function runSimulationSteps() {
    const steps = parseInt(document.getElementById("simStepCount").value) || 100;
    const res = await fetch(`/api/simulate/bulk/{{ project.id }}/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ steps: steps })
    });

    const data = await res.json();
    const tbody = document.querySelector("#simTable tbody");
    tbody.innerHTML = "";

    if (data.success) {
        data.results.forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${row.step}</td>
                <td>${row.time}</td>
                <td>${row.event || "-"}</td>
                <td>${row.stock || "-"}</td>
                <td>${row.old_value ?? "-"}</td>
                <td>${row.new_value ?? "-"}</td>
            `;
            tbody.appendChild(tr);
        });

        // ðŸ”¥ Burada grafik Ã§izimi yapÄ±lÄ±r
        drawStockChart(data.results);
        showToast(`Simulated ${steps} steps`);
        fetchStocks();  // gÃ¼ncel stock deÄŸerlerini yenile
    } else {
        showToast(data.error || "Simulation failed", true);
    }
}


async function runSimulation() {
    const res = await fetch(`/api/simulate/{{ project.id }}/`);
    const data = await res.json();
    if (data.success) {
        document.getElementById("simResult").textContent = JSON.stringify(data.result, null, 2);
        showToast("Simulation complete");
        fetchStocks();  // gÃ¼ncel deÄŸerleri Ã§ek
    } else {
        showToast(data.error || "Simulation failed", true);
    }
}

let draggedVariable = "";

async function loadStockVariables(projectId) {
    const res = await fetch(`/api/stocks/variables/?project_id=${projectId}`);
    const data = await res.json();

    const container = document.getElementById("stockVarsContainer");
    container.innerHTML = "";

    if (data.success && data.variables.length > 0) {
        data.variables.forEach(varName => {
            const badge = document.createElement("span");
            badge.className = "badge bg-secondary text-light px-2 py-1 me-2 mb-2";
            badge.style.cursor = "grab";
            badge.setAttribute("draggable", "true");
            badge.textContent = varName;

            // Drag baÅŸlatÄ±ldÄ±ÄŸÄ±nda
            badge.addEventListener("dragstart", (e) => {
                draggedVariable = `stock('${varName}')`;
                e.dataTransfer.setData("text/plain", draggedVariable);
            });

            container.appendChild(badge);
        });
    } else {
        container.innerHTML = "<span class='text-muted'>No variables available</span>";
    }
}

function onDropVariable(event, input) {
    event.preventDefault();
    const insertText = draggedVariable || event.dataTransfer.getData("text/plain");

    const cursorPos = input.selectionStart || input.value.length;
    input.value = input.value.slice(0, cursorPos) + insertText + input.value.slice(cursorPos);
}

function allowDrop(event) {
    event.preventDefault();
}
async function deleteEvent(eventId, stockId) {
    if (!confirm("Delete this event?")) return;
    const res = await fetch(`/api/events/delete/${eventId}/`, { method: "DELETE" });
    const data = await res.json();
    if (data.success) {
        showToast("Event deleted");
        loadStockDetail(stockId);
    } else {
        showToast(data.error, true);
    }
}


async function loadStockDetail(stockId) {
    const stockRes = await fetch(`/api/stocks/read/${stockId}/`);
    const stockData = await stockRes.json();
    if (stockData.success) {
        document.getElementById("stockDetailLabel").textContent = stockData.stock.name;
        document.getElementById("stockValue").textContent = "Value: " + stockData.stock.value;
        document.getElementById("eventStockId").value = stockId;
    }

    const eventsRes = await fetch(`/api/events/list/?stock_id=${stockId}`);
    const eventsData = await eventsRes.json();
    const eventList = document.getElementById("eventList");
    eventList.innerHTML = "";

    if (eventsData.success && eventsData.events.length > 0) {
        eventsData.events.forEach(ev => {
            const li = document.createElement("li");
            li.className = "list-group-item";
            li.innerHTML = `<strong>${ev.name}</strong> â€” ${ev.effect} (p=${ev.possibility})  <button class="btn btn-sm btn-outline-danger btn-sm float-end" onclick="deleteEvent(${ev.id}, ${stockId})">&times;</button>
`;
            eventList.appendChild(li);
        });
    } else {
        eventList.innerHTML = "<li class='list-group-item text-muted'>No events.</li>";
    }
}


document.getElementById("addEventForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const form = e.target;
    const payload = {
        stock_id: form.stock_id.value,
        name: form.name.value,
        possibility: form.possibility.value,
        effect: form.effect.value
    };

    const res = await fetch("/api/events/create/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (data.success) {
        showToast("Event created.");
        form.reset();
        loadStockDetail(payload.stock_id);
    } else {
        showToast(data.error || "Error creating event", true);
    }
});
    async function fetchStocks() {
    const res = await fetch("{% url 'list_stocks_api' %}?project_id={{ project.id }}");
    const data = await res.json();
    const container = document.getElementById("stockList");
    container.innerHTML = "";

    if (data.success) {
        if (data.stocks.length === 0) {
            container.innerHTML = "<li class='text-gray-400'>No stocks found.</li>";
            return;
        }

        data.stocks.forEach(stock => {
    const card = document.createElement("div");
    card.className = "bg-white shadow p-4 rounded cursor-pointer hover:ring-2 hover:ring-blue-500 transition";
    card.innerHTML = `
        <h3 class="text-lg font-semibold">${stock.name}</h3>
        <p class="text-gray-700">Value: ${stock.value}</p>
    `;

const deleteBtn = document.createElement("button");
deleteBtn.className = "btn btn-sm btn-danger float-end";
deleteBtn.innerHTML = "&times;";
deleteBtn.onclick = async (e) => {
    e.stopPropagation();
    if (!confirm("Are you sure you want to delete this stock?")) return;
    const res = await fetch(`/api/stocks/delete/${stock.id}/`, { method: "DELETE" });
    const data = await res.json();
    if (data.success) {
        showToast("Stock deleted");
        fetchStocks();
    } else {
        showToast(data.error, true);
    }
};

card.appendChild(deleteBtn);
    card.addEventListener('click', () => openStockModal(stock.id));
    container.appendChild(card);
});
    } else {
        container.innerHTML = `<li class="text-red-500">${data.error || "Error loading stocks."}</li>`;
    }
}

fetchStocks();  // sayfa yÃ¼klendiÄŸinde Ã§aÄŸÄ±r
document.getElementById('addStockForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const name = form.name.value.trim();
    const value = form.value.value.trim();
    const projectId = {{ project.id }};

    if (!name || !value) return;

    const res = await fetch("{% url 'create_stock_api' %}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, value, project_id: projectId })
    });

    const data = await res.json();

    if (data.success) {
        showToast(data.message);
        form.reset();
        fetchStocks();  // stoklarÄ± yeniden getir
    } else {
        showToast(data.error || 'Error occurred', true);
    }
});

function showToast(message, isError = false) {
    const toast = document.getElementById('toast');
    toast.classList.remove('hidden');
    toast.classList.remove('bg-green-600', 'bg-red-600');
    toast.classList.add(isError ? 'bg-red-600' : 'bg-green-600');
    toast.textContent = message;
    setTimeout(() => {
        toast.classList.add('hidden');
    }, 3000);
}
</script>

</html>
